
# Анализ сайта [Lifehacker]

Сайт [Lifehacker] было проанализировано при помощи следующих сервисов и плагинов:

- WebPageTest
- YSlow
- PageSpeed Insights

Данные проведенных тестов WebPageTest для разных стран :

- [Америка] 
- [Европа] 
- [iOS Америка]


### 1. Использование нескольких ДЦ

Не применяется, существует только одна копия сайта. Согласно полученным данным с DNS сервера, к домену lifehacker.ru привязан только один IP адрес - 148.251.83.28. При росте нагрузок на сервер нужно использовать методы балансировки нагрузки на несколько серверов, в первую очередь для статики (например, большие картинки), методом Round robin и др.

### 2. Использование CDN

CDN не используется для загрузки библиотек jQuery. Необходимо сделать их загрузку из публичного CDN. 

> https://lifehacker.ru/wp-includes/js/jquery/jquery.js?ver=1.12.4
> https://lifehacker.ru/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1

### 3. Время установки соединения

По данным с WebPageTest время до получения первого байта при тестировании с европейского сервера составляет не более 200 мс, что является приемлемым показателем. При тестировании же с северо-американского сервера - 2460 мс, что является большим показателем и приводит к заметной задержке в загрузке. Разработчикам сайта следует обратить на это внимание при желании охватить северо-американскую и другие удаленные от физического расположения хостинга территории.

![01](https://cloud.githubusercontent.com/assets/18663439/17390106/ad692308-5a12-11e6-9587-4c158e73c3cd.png)

### 4. Размер ресурсов

Очень большой размер загружаемых ресурсов - при первой загрузке 24 Мб. Загружается большое число объемных картинок, до многих из которых пользователь может и не добраться, если не прокрутит сайт вниз, а перейдет по какой-либо ссылке раньше. Необходимо сделать динамическую подгрузку содержимого при скроллинге, включая картинки (на примере загрузки новостной ленты ВКонтакте).

![02](https://cloud.githubusercontent.com/assets/18663439/17390133/e367e89a-5a12-11e6-86e3-4902007a717b.png)

### 5. Адаптивность изображений

Размер загружаемых файлов не изменяется при использовании мобильного устройства. Данные теста на iOS с WebPageTest показывают, что для мобильной версии загружаются картинки большого размера. Необходимо использовать соответствующие версии изображений для различных устройств, особенно, для мобильных устройств с маленькими размерами экрана, нет смысла использования десктопных версий, поскольку загрузка происходит через мобильный интернет. Для retina устройств можно реализовать изначальную подгрузку маленького изображения и после отображения всего контента страницы подгрузить изображение с более высоким разрешением.

![03](https://cloud.githubusercontent.com/assets/18663439/17390143/f961cfbc-5a12-11e6-8a10-1eaac782e3d1.png)

### 6. Порядок подключения и блокирующие скрипты

Анализатор Yslow выявил 7 файлов javascript, подключенных в head документа:

![04](https://cloud.githubusercontent.com/assets/18663439/17390166/23572e70-5a13-11e6-909f-7894e5161a9a.png)

Это так же можно увидеть в исходном коде:

![05](https://cloud.githubusercontent.com/assets/18663439/17390175/4245dcc8-5a13-11e6-80da-449a3be0085e.png)

Среди скриптов присутствует библиотеки jQuery. В данном случае они являются блокирующими т.к. отсутствует флаг async. Необходимо перенести их в конец файла. Скрипты необходимо подключать в конце документа, при этом также всегда необходимо выставлять режим загрузки sync или defer, что предотвратит блокирование загрузки и рендеринга Dom-а.

Самые необходимые сss стили, без которых не возможно отображение страницы, по возможности лучше заинлайнить. При подключении стилей можно воспользоваться media="none" для предотвращения блокировки рендеринга до момента загрузки стиля, после его заорузки менять в media="all".

Изображения большого размера, например фон, лучше загружать в самом конце.

### 7. DNS Lookup

Число используемых доменов очень велико. На графике WebPageTest, отображающем процентное число запросов по доменам, можно увидеть очень большое число разных доменов, что приводит к большому числу DNS резолвов (в данном пункте на графике нас интересует только количество разных доменов, о количестве запросов пойдет речь ниже).

![06](https://cloud.githubusercontent.com/assets/18663439/17390189/553e9270-5a13-11e6-8ad3-e600fd137665.png)

Yslow так же говорит нам о проблемах с количеством DNS запросов.

![07](https://cloud.githubusercontent.com/assets/18663439/17390194/68c2cab4-5a13-11e6-9421-f243a9a0c10b.png)

По данным с WebPageTest загрузка страницы приводит к обращению к 58 доменам, из них только 23 являются CDN, т.е. остается еще 25 доменов, что очень много. Рекомендуемое их число должно быть не более 5.

### 8. Кэширование

Анализатор PageSpeed выдает следующую картину.

![10](https://cloud.githubusercontent.com/assets/18663439/17390215/9241ca2a-5a13-11e6-986d-c5495e878dd5.png)

Что говорит о том, что отсутствует информация об времени жизни (expiration) для некоторых ресурсов, в том числе и загруженных с CDN. Так же присутствует очень большое количество статики, которая не использует отдельный домен, а расположена вместе с остальным контентом.

Необходимо использовать cookie-free домен для размещения на нем статических ресурсов сайта, указать их expiration, что позволит браузерам корректно кэшировать их. Использование cookie-free домена так же сократит траффик, поскольку ненужная информация о cookie не будет передаваться вместе с запросом ресурса.

Ниже приведена выдержка - это стили, скрипты и иконки:

> https://lifehacker.ru/wp-content/themes/lifehacker/static/fonts/style.css?ver=13
> https://lifehacker.ru/wp-content/plugins/lh-social-slider/assets/js/common.js?ver=1.8
> https://lifehacker.ru/wp-content/themes/lifehacker/static/img/logo.svg

![09](https://cloud.githubusercontent.com/assets/18663439/17390218/a7211dce-5a13-11e6-8bbe-3430ddca3099.png)

### 9. Сжатие gzip, sdch

Анализатор PageSpeed показывает информацию о том, какой выигрыш можно получить если использовать сжатие gzip. Применив сжатие скриптов и стилей можно получить выигрыш в 45 кбайт. Так же для более лучшего результата можно использовать сжатие sdch.

![12](https://cloud.githubusercontent.com/assets/18663439/17390235/c2ebe7f0-5a13-11e6-9cd5-5559ec608640.png)

### 10. Сжатие картинок, использование спрайтов и прогрессивных JPEG

Необходимо использование утилиты jpegtran для удаления метаданных из jpeg изображений (EXIF), а также для создания прогрессивных jpeg, содержащих кроме основного, его копию в низком разрещении для более быстрого ее показа пользователю с последюущим улучшением качества, после загрузки полной версии изображения.
Для формата png необходимо использовать утилиту pngcrush или аналогичную, выполняющую сжатие без потери качества.

Так же необходимо исключить использование больших изображений, там где на самом деле нужны меньшего размера. Так например следующее [изображение]  в реальности вставляется в меньшую область чем его размер.

Нежелательно использовать уменьшение картинок средствами css. Если нужна картинка 100*100 то загружать с сервера нужно изображение именно с таким размером. На анализируемой странице используется 9 изображений уменьшенных при помощи css стилей.

### 11. Объединение, минификация и обфускация файлов

Несмотря на то что большинство файлов на сайте минифицированы, есть и исключения. Анализаторы PageSpeed и Yslow сообщают о необходимости минификации файлов, среди которых есть следующие:
> https://lifehacker.ru/wp-content/plugins/lh-mumigrate/static/public/css/main.css?ver=4.5.3
> https://lifehacker.ru/wp-content/themes/lifehacker/static/js/all.min.js?ver=13
> https://vk.com/js/api/openapi.js

Несмотря на то, что Файл "all.min.js?ver=13" имеет постфикс "min" в своем имени, на самом деле он не минифицирован, а так же содержит много комментариев, поэтому требуется выполнить корректную минификацию для него.

![11](https://cloud.githubusercontent.com/assets/18663439/17390244/d89f330e-5a13-11e6-8d38-6a0ca2d57977.png)

Для файла "openapi.js", лежащего в домене vk.com, было проверено наличие минифицированной версии, однако таковой найдено не было.
Файл https://vk.com/js/api/openapi.min.js не существует, так что в данном случае это минус ВКонтакте, о чем подтверждает ссылка https://new.vk.com/dev/openapi

Так же необходимо провести обфускацию всех javascript файлов с целью уменьшения их объема, т.к. имена многих переменных и функций имеют большую длину.
Например: positionWhereWidgetsWillBeFixed, moveWidgetsToOriginalPosition.

### 12. Количество запросов

При загрузке страницы происходит очень большое число запросов, что можно увидеть ниже по данным анализатора WebPagetest:

![13](https://cloud.githubusercontent.com/assets/18663439/17390251/f0b51864-5a13-11e6-9b3a-2b0fa18e67a4.png)

Необходимо объединить используемые  скрипты и css стили в один файл, загружать картинки динамически по мере надобности, картинки необходимые при первой загрузке и иконки объединить в spritesheets. Также возможно использование SPDY для передачи нескольких ресурсов в рамках одного соединения.

Анализатор Yslow сообщает:
> This page has 37 external Javascript scripts. Try combining them into one.
> This page has 20 external stylesheets. Try combining them into one.
> This page has 56 external background images. Try combining them with CSS sprites.

### 13. Формирование критичной функциональности

На данный момент для рендеринга первоначального состояния страницы требуется несколько сетевых round-trips. Необходимо определить приоритетный контент для отображения и передавать его в рамках одного запроса, размер должен быть не больше 14 кб, что соответствует размеру одного пакета.

### 14. Шрифты

Используется шрифт icomoon для отображения иконок, при этом в нем содержатся все возможные иконки. Для оптимизации загружаемого размера необходимо кастомизировать шрифт и включить в него только используемые элементы.

### 15. Количество элментов в DOM

Большое количество элементов предполагает большее количество байт для загрузки, а так же и более медленный доступ к DOM элементам из JavaScript. В разметке сайта содержится достаточно большое количество дивов, вложенных друг в друга. Возможно при более тщательной верстке документа удастся избавиться от некоторых из них не меняя содержимого страницы.

[Lifehacker]: <https://lifehacker.ru>
[Америка]: <http://www.webpagetest.org/result/160803_N5_3Q6K>
[Европа]: <https://www.webpagetest.org/result/160803_CJ_3YDD>
[iOS Америка]: <https://www.webpagetest.org/result/160803_5K_47B0>
[изображение]:  <https://lifehacker.ru/wp-content/uploads/2015/12/Bitmap_1470236020-1600x800.jpg>

